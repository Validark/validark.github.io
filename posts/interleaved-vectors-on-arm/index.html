<!DOCTYPE html><html class="transition bg-[var(--page-bg)] md:text-[16px] text-[14px]" data-astro-cid-sckkx6r4 lang=en-us style=--configHue:285><head><title>Use interleaved vectors for parsing on ARM - Validark&#39;s Blog</title><meta charset=UTF-8><meta content="Why using interleaved vectors via LD4 results in efficiency gains" name=description><meta content="Niles Salter" name=author><meta content="Validark's Blog" property=og:site_name><meta content=https://validark.github.io/posts/interleaved-vectors-on-arm/ property=og:url><meta content="Use interleaved vectors for parsing on ARM - Validark's Blog" property=og:title><meta content="Why using interleaved vectors via LD4 results in efficiency gains" property=og:description><meta content=summary_large_image name=twitter:card><meta content=https://validark.github.io/posts/interleaved-vectors-on-arm/ property=twitter:url><meta content="Use interleaved vectors for parsing on ARM - Validark's Blog" name=twitter:title><meta content="Why using interleaved vectors via LD4 results in efficiency gains" name=twitter:description><meta content="width=device-width" name=viewport><meta content="Astro v4.14.2" name=generator><link href=/favicon/favicon-light-32.png rel=icon media="(prefers-color-scheme: light)" sizes=32x32><link href=/favicon/favicon-light-128.png rel=icon media="(prefers-color-scheme: light)" sizes=128x128><link href=/favicon/favicon-light-180.png rel=icon media="(prefers-color-scheme: light)" sizes=180x180><link href=/favicon/favicon-light-192.png rel=icon media="(prefers-color-scheme: light)" sizes=192x192><link href=/favicon/favicon-dark-32.png rel=icon media="(prefers-color-scheme: dark)" sizes=32x32><link href=/favicon/favicon-dark-128.png rel=icon media="(prefers-color-scheme: dark)" sizes=128x128><link href=/favicon/favicon-dark-180.png rel=icon media="(prefers-color-scheme: dark)" sizes=180x180><link href=/favicon/favicon-dark-192.png rel=icon media="(prefers-color-scheme: dark)" sizes=192x192><script>!function(){switch(localStorage.getItem("theme")||"auto"){case"light":document.documentElement.classList.remove("dark");break;case"dark":document.documentElement.classList.add("dark");break;case"auto":window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}}()</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Use interleaved vectors for parsing on ARM","description":"Why using interleaved vectors via LD4 results in efficiency gains","keywords":["simd"],"author":{"@type":"Person","name":"Niles Salter","url":"https://validark.github.io/"},"datePublished":"2024-09-03","inLanguage":"en-us"}</script><link href=https://cdn.staticfile.net/KaTeX/0.16.9/katex.min.css rel=stylesheet crossorigin=anonymous integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV><link href=https://validark.github.io/rss.xml rel=alternate title="Niles Salter" type=application/rss+xml><link href=/_astro/hoisted.DwNyjBsW.css rel=stylesheet><link href=/_astro/_slug_.B3Mico7e.css rel=stylesheet><link href=/_astro/_page_.BBPem2Fh.css rel=stylesheet><link href=/_astro/index.Bf0UvkyB.css rel=stylesheet><style>#display-setting.svelte-3akcb9 input[type=range].svelte-3akcb9{-webkit-appearance:none;height:1.5rem;background-image:var(--color-selection-bar);transition:background-image .15s ease-in-out}#display-setting.svelte-3akcb9 .svelte-3akcb9::-webkit-slider-thumb{-webkit-appearance:none;height:1rem;width:.5rem;border-radius:.125rem;background:#ffffffb3;box-shadow:none}#display-setting.svelte-3akcb9 .svelte-3akcb9::-webkit-slider-thumb:hover{background:#fffc}#display-setting.svelte-3akcb9 .svelte-3akcb9::-webkit-slider-thumb:active{background:#fff9}#display-setting.svelte-3akcb9 .svelte-3akcb9::-moz-range-thumb{-webkit-appearance:none;height:1rem;width:.5rem;border-radius:.125rem;border-width:0;background:#ffffffb3;box-shadow:none}#display-setting.svelte-3akcb9 .svelte-3akcb9::-moz-range-thumb:hover{background:#fffc}#display-setting.svelte-3akcb9 .svelte-3akcb9::-moz-range-thumb:active{background:#fff9}#display-setting.svelte-3akcb9.svelte-3akcb9::-ms-thumb{-webkit-appearance:none;height:1rem;width:.5rem;border-radius:.125rem;background:#ffffffb3;box-shadow:none}#display-setting.svelte-3akcb9.svelte-3akcb9::-ms-thumb:hover{background:#fffc}#display-setting.svelte-3akcb9.svelte-3akcb9::-ms-thumb:active{background:#fff9}</style><script type=module src=/_astro/hoisted.M2b4Olb-.js></script><script type=module src=/_astro/page.0NdQ2tHG.js></script></head><body class="transition min-h-screen" data-astro-cid-sckkx6r4 style=--configHue:285><div id=config-carrier data-hue=285></div><div><div class="w-full absolute duration-700 transition-all" id=banner-wrapper style=--configHue:285 data-astro-cid-sckkx6r4><div class="relative overflow-hidden h-full hidden object-cover" id=boxtest><div class="transition absolute pointer-events-none bg-opacity-50 dark:bg-black/10 inset-0"></div><img alt="Banner image of the blog" src=/_astro/demo-banner.WD4SMgz__nlqjd.webp decoding=async height=1369 loading=lazy width=1920 class="w-full h-full object-cover" style=object-position:center></div></div><div class="relative mx-auto gap-4 grid grid-cols-[17.5rem_auto] grid-rows-[auto_auto_1fr_auto] lg:grid-rows-[auto_1fr_auto] max-w-[var(--page-width)] md:px-4 min-h-screen px-0"><div class="relative transition-all col-span-2 duration-700 grid-rows-1" id=top-row><div class="onload-animation sticky top-0 z-50" id=navbar><div class="transition absolute -top-8 bg-[var(--card-bg)] h-8 left-0 right-0"></div><div class="flex items-center card-base max-w-[var(--page-width)] mx-auto h-[4.5rem] justify-between overflow-visible px-4 rounded-t-none"><a href=/ class="h-11 rounded-lg btn-plain scale-animation active:scale-95 font-bold pl-5 pr-[0.85em]"><div class="flex items-center flex-row text-[var(--primary)] text-md"><svg data-icon=material-symbols:home-outline-rounded height=1em viewBox="0 0 24 24" width=1em class="text-[1.75rem] mb-1 mr-2"><symbol id=ai:material-symbols:home-outline-rounded><path d="M6 19h3v-5q0-.425.288-.712T10 13h4q.425 0 .713.288T15 14v5h3v-9l-6-4.5L6 10zm-2 0v-9q0-.475.213-.9t.587-.7l6-4.5q.525-.4 1.2-.4t1.2.4l6 4.5q.375.275.588.7T20 10v9q0 .825-.588 1.413T18 21h-4q-.425 0-.712-.288T13 20v-5h-2v5q0 .425-.288.713T10 21H6q-.825 0-1.412-.587T4 19m8-6.75" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:home-outline-rounded></use></svg></div></a><div class="hidden md:flex"></div><div class=flex><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(self.Astro||(self.Astro={})).load=async t=>{await(await t())()},window.dispatchEvent(new Event("astro:load")),(()=>{var t=Object.defineProperty,e=(e,r,n)=>((e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n);{let t={0:t=>s(t),1:t=>n(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(n(t)),5:t=>new Set(n(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},r=e=>{let[r,n]=e;return r in t?t[r](n):void 0},n=t=>t.map(r),s=t=>"object"!=typeof t||null===t?t:Object.fromEntries(Object.entries(t).map((([t,e])=>[t,r(e)])));class i extends HTMLElement{constructor(){super(...arguments),e(this,"Component"),e(this,"hydrator"),e(this,"hydrate",(async()=>{var t;if(!this.hydrator||!this.isConnected)return;let e=null==(t=this.parentElement)?void 0:t.closest("astro-island[ssr]");if(e)return void e.addEventListener("astro:hydrate",this.hydrate,{once:!0});let r,n=this.querySelectorAll("astro-slot"),i={},o=this.querySelectorAll("template[data-astro-template]");for(let t of o){let e=t.closest(this.tagName);null!=e&&e.isSameNode(this)&&(i[t.getAttribute("data-astro-template")||"default"]=t.innerHTML,t.remove())}for(let t of n){let e=t.closest(this.tagName);null!=e&&e.isSameNode(this)&&(i[t.getAttribute("name")||"default"]=t.innerHTML)}try{r=this.hasAttribute("props")?s(JSON.parse(this.getAttribute("props"))):{}}catch(t){let e=this.getAttribute("component-url")||"<unknown>",r=this.getAttribute("component-export");throw r&&(e+=` (export ${r})`),console.error(`[hydrate] Error parsing props for component ${e}`,this.getAttribute("props"),t),t}await this.hydrator(this)(this.Component,r,i,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))})),e(this,"unmount",(()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))}))}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(this.hasAttribute("await-children")&&"interactive"!==document.readyState&&"complete"!==document.readyState){let t=()=>{document.removeEventListener("DOMContentLoaded",t),e.disconnect(),this.childrenConnectedCallback()},e=new MutationObserver((()=>{var e;(null==(e=this.lastChild)?void 0:e.nodeType)===Node.COMMENT_NODE&&"astro:end"===this.lastChild.nodeValue&&(this.lastChild.remove(),t())}));e.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",t)}else this.childrenConnectedCallback()}async childrenConnectedCallback(){let t=this.getAttribute("before-hydration-url");t&&await import(t),this.start()}async start(){let t=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(void 0!==Astro[e])try{await Astro[e]((async()=>{let t=this.getAttribute("renderer-url"),[e,{default:r}]=await Promise.all([import(this.getAttribute("component-url")),t?import(t):()=>()=>{}]),n=this.getAttribute("component-export")||"default";if(n.includes(".")){this.Component=e;for(let t of n.split("."))this.Component=this.Component[t]}else this.Component=e[n];return this.hydrator=r,this.hydrate}),t,this)}catch(t){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,t)}else window.addEventListener(`astro:${e}`,(()=>this.start()),{once:!0})}attributeChangedCallback(){this.hydrate()}}e(i,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",i)}})()</script><astro-island await-children="" client=load component-export=default component-url=/_astro/Search.gYMCSYYZ.js opts={&quot;name&quot;:&quot;Search&quot;,&quot;value&quot;:true} props={} renderer-url=/_astro/client.Cx1FBVJX.js ssr="" uid=1tgfRC><div class="h-11 rounded-lg bg-black/[0.04] dark:bg-white/5 dark:focus-within:bg-white/10 dark:hover:bg-white/10 focus-within:bg-black/[0.06] hidden hover:bg-black/[0.06] items-center lg:flex mr-2 transition-all" id=search-bar><astro-slot name=search-icon><svg data-icon=material-symbols:search height=1em viewBox="0 0 24 24" width=1em class="transition absolute pointer-events-none dark:text-white/30 ml-3 my-auto text-[1.25rem] text-black/30" slot=search-icon><symbol id=ai:material-symbols:search><path d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:search></use></svg></astro-slot><input class="text-sm bg-transparent dark:text-white/50 outline-0 pl-10 text-black/50 h-full transition-all w-[60rem]" placeholder=Search value=""></div><button class="h-11 rounded-lg btn-plain scale-animation active:scale-90 w-11 lg:hidden" aria-label="Search Panel" id=search-switch><astro-slot name=search-switch><svg data-icon=material-symbols:search height=1em viewBox="0 0 24 24" width=1em class=text-[1.25rem] slot=search-switch><use xlink:href=#ai:material-symbols:search></use></svg></astro-slot></button><div class="absolute float-panel-closed float-panel right-4 left-4 md:left-[unset] md:w-[100%] p-2 rounded-2xl search-panel shadow-2xl top-20" id=search-panel><div class="flex items-center bg-black/[0.04] dark:bg-white/5 dark:focus-within:bg-white/10 dark:hover:bg-white/10 focus-within:bg-black/[0.06] h-11 hover:bg-black/[0.06] lg:hidden relative rounded-xl transition-all" id=search-bar-inside><astro-slot name=search-icon><svg data-icon=material-symbols:search height=1em viewBox="0 0 24 24" width=1em class="transition absolute pointer-events-none dark:text-white/30 ml-3 my-auto text-[1.25rem] text-black/30" slot=search-icon><symbol id=ai:material-symbols:search><path d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:search></use></svg></astro-slot><input class="absolute inset-0 bg-transparent dark:text-white/50 focus:w-60 outline-0 pl-10 text-black/50 text-sm" placeholder=Search value=""></div></div><template data-astro-template=arrow-icon><svg data-icon=fa6-solid:chevron-right height=1em viewBox="0 0 320 512" width=0.63em class="transition text-[var(--primary)] my-auto text=[0.75rem] translate-x-0.5" slot=arrow-icon><symbol id=ai:fa6-solid:chevron-right><path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256L73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z" fill=currentColor /></symbol><use xlink:href=#ai:fa6-solid:chevron-right></use></svg></template></astro-island><astro-island await-children="" client=load component-export=default component-url=/_astro/LightDarkSwitch.CUOehYNf.js opts={&quot;name&quot;:&quot;LightDarkSwitch&quot;,&quot;value&quot;:true} props={} renderer-url=/_astro/client.Cx1FBVJX.js ssr="" uid=jFFc9><div class="relative z-50" role=menu tabindex=-1><button class="relative h-11 active:scale-90 btn-plain rounded-lg scale-animation w-11" aria-label="Light/Dark Mode" id=scheme-switch role=menuitem><div class="absolute opacity-0"></div><div class="absolute opacity-0"></div><div class=absolute></div></button><div class="transition absolute -right-2 float-panel-closed hidden lg:block pt-5 top-11" id=light-dark-panel><div class="float-panel p-2 card-base"><button class="transition flex items-center w-full active:scale-95 btn-plain font-medium h-9 justify-start px-3 rounded-lg scale-animation whitespace-nowrap mb-0.5">Light</button> <button class="transition flex items-center w-full active:scale-95 btn-plain font-medium h-9 justify-start px-3 rounded-lg scale-animation whitespace-nowrap mb-0.5">Dark</button> <button class="transition flex items-center w-full active:scale-95 btn-plain font-medium h-9 justify-start px-3 rounded-lg scale-animation whitespace-nowrap current-theme-btn">System</button></div></div></div></astro-island><button class="h-11 rounded-lg btn-plain scale-animation active:scale-90 w-11 md:hidden" aria-label=Menu id=nav-menu-switch name="Nav Menu"><svg data-icon=material-symbols:menu-rounded height=1em viewBox="0 0 24 24" width=1em class=text-[1.25rem]><symbol id=ai:material-symbols:menu-rounded><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h16q.425 0 .713.288T21 17t-.288.713T20 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:menu-rounded></use></svg></button></div><div class="absolute float-panel-closed float-panel right-4 fixed px-2 py-2 transition-all" id=nav-menu-panel></div><script>(self.Astro||(self.Astro={})).only=async t=>{await(await t())()},window.dispatchEvent(new Event("astro:only"))</script><astro-island await-children="" client=only component-export=default component-url=/_astro/DisplaySettings.C1UqXPKT.js opts={&quot;name&quot;:&quot;DisplaySettings&quot;,&quot;value&quot;:&quot;svelte&quot;} props={} renderer-url=/_astro/client.Cx1FBVJX.js ssr="" uid=Z2atdkc><template data-astro-template=restore-icon><svg data-icon=fa6-solid:arrow-rotate-left height=1em viewBox="0 0 512 512" width=1em class=text-[0.875rem] slot=restore-icon><symbol id=ai:fa6-solid:arrow-rotate-left><path d="M125.7 160H176c17.7 0 32 14.3 32 32s-14.3 32-32 32H48c-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32s32 14.3 32 32v51.2l17.6-17.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0z" fill=currentColor /></symbol><use xlink:href=#ai:fa6-solid:arrow-rotate-left></use></svg></template></astro-island></div></div><script>!async function(){const i=await import("/pagefind/pagefind.js");await i.options({excerptLength:20}),i.init(),window.pagefind=i,i.search("")}()</script></div><div class="w-full col-span-2 lg:col-span-1 lg:max-w-[17.5rem] lg:row-end-3 lg:row-start-2 onload-animation row-end-4 row-start-3 xl:absolute xl:left-[-276px] xl:row-end-[none]" id=sidebar><div class="flex w-full flex-col gap-4 mb-4"><div class="p-3 card-base"><a href=https://github.com/Validark class="relative overflow-hidden lg:mt-0 mx-auto active:scale-95 block group lg:max-w-none lg:mx-0 max-w-[240px] mb-3 mt-1 rounded-full" aria-label="Go to GitHub Page"><div class="transition absolute pointer-events-none flex group-active:bg-white/20 group-hover:bg-white/20 h-full items-center justify-center w-full z-50"><svg data-icon=fa6-brands:github height=1em viewBox="0 0 496 512" width=0.97em class="transition group-hover:opacity-100 group-hover:scale-[6.2] opacity-0 scale-[5] text-5xl text-white" style=color:#662f1e><symbol id=ai:fa6-brands:github><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6c-3.3.3-5.6-1.3-5.6-3.6c0-2 2.3-3.6 5.2-3.6c3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9c2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9c.3 2 2.9 3.3 5.9 2.6c2.9-.7 4.9-2.6 4.6-4.6c-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2c12.8 2.3 17.3-5.6 17.3-12.1c0-6.2-.3-40.4-.3-61.4c0 0-70 15-84.7-29.8c0 0-11.4-29.1-27.8-36.6c0 0-22.9-15.7 1.6-15.4c0 0 24.9 2 38.6 25.8c21.9 38.6 58.6 27.5 72.9 20.9c2.3-16 8.8-27.1 16-33.7c-55.9-6.2-112.3-14.3-112.3-110.5c0-27.5 7.6-41.3 23.6-58.9c-2.6-6.5-11.1-33.3 2.6-67.9c20.9-6.5 69 27 69 27c20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27c13.7 34.7 5.2 61.4 2.6 67.9c16 17.7 25.8 31.5 25.8 58.9c0 96.5-58.9 104.2-114.8 110.5c9.2 7.9 17 22.9 17 46.4c0 33.7-.3 75.4-.3 83.6c0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252C496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2c1.6 1.6 3.9 2.3 5.2 1c1.3-1 1-3.3-.7-5.2c-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9c1.6 1 3.6.7 4.3-.7c.7-1.3-.3-2.9-2.3-3.9c-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2c2.3 2.3 5.2 2.6 6.5 1c1.3-1.3.7-4.3-1.3-6.2c-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2c-1.4-2.3-4-3.3-5.6-2" fill=currentColor /></symbol><use xlink:href=#ai:fa6-brands:github></use></svg></div><div class="relative overflow-hidden h-full lg:mt-0 lg:w-full mx-auto"><div class="transition absolute pointer-events-none bg-opacity-50 dark:bg-black/10 inset-0"></div><img alt="Profile Image of the Author" src=/Validark.jpeg class="w-full h-full object-cover" style=object-position:center></div></a><div class=px-2><div class="transition font-bold dark:text-neutral-50 mb-1 text-center text-xl"><span class="custom-md prose"><a href=https://github.com/Validark style=font-size:15pt;text-decoration:none>Niles Salter / @Validark</a></span></div><div class="transition mb-2 bg-[var(--primary)] h-1 mx-auto rounded-full w-5"></div><div class="transition text-center text-xl mb-2.5 text-neutral-400">Gotta go fast!</div><div class="flex gap-2 justify-center mb-1"></div></div></div></div><div class="flex w-full flex-col gap-4 top-4 top-4 sticky"><widget-layout class="onload-animation card-base pb-4" data-astro-cid-ucso7hve data-id=tags data-is-collapsed=false style=animation-delay:.2s;--collapsedHeight:7.5rem><div class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-4 before:left-[-16px] before:top-[5.5px] before:w-1 dark:text-neutral-100 mb-2 ml-8 mt-4 relative text-lg text-neutral-900" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve>Tags</div><div class="collapse-wrapper overflow-hidden px-4" id=tags style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><div class="flex flex-wrap gap-2"><a href=/posts/tag/all/ class="text-sm btn-regular h-8 px-3 rounded-lg" aria-label="View all posts with the all tag">all </a><a href=/posts/tag/simd/ class="text-sm btn-regular h-8 px-3 rounded-lg" aria-label="View all posts with the simd tag">simd</a></div></div></widget-layout></div></div><div class="onload-animation col-span-2 lg:col-span-1 overflow-hidden row-end-3 row-start-2 xl:col-span-2" id=content-wrapper><main class=transition-swup-fade id=swup-container><div class="flex w-full mb-4 overflow-hidden relative rounded-[var(--radius-large)]"><div class="w-full relative card-base md:px-9 pb-4 pt-6 px-6 z-10" id=post-container><div class="transition flex dark:text-white/30 flex-row gap-5 mb-3 onload-animation text-black/30"><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg data-icon=material-symbols:notes-rounded height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:material-symbols:notes-rounded><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h10q.425 0 .713.288T15 17t-.288.713T14 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:notes-rounded></use></svg></div><div class=text-sm>1846 words</div></div><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg data-icon=material-symbols:schedule-outline-rounded height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:material-symbols:schedule-outline-rounded><path d="M13 11.6V8q0-.425-.288-.712T12 7t-.712.288T11 8v3.975q0 .2.075.388t.225.337l3.3 3.3q.275.275.7.275T16 16t.275-.7t-.275-.7zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.325 0 5.663-2.337T20 12t-2.337-5.663T12 4T6.337 6.338T4 12t2.338 5.663T12 20" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:schedule-outline-rounded></use></svg></div><div class=text-sm>9 minutes</div></div></div><div class="relative onload-animation"><h1 class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-5 before:left-[-1.125rem] before:top-[0.75rem] block dark:text-white/90 mb-3 md:before:w-1 md:text-[2.5rem]/[2.75rem] text-3xl text-black/90 w-full" data-pagefind-body data-pagefind-meta=title data-pagefind-weight=10>Use interleaved vectors for parsing on ARM</h1></div><div class=onload-animation><div class="flex items-center dark:text-neutral-400 flex-wrap gap-4 gap-x-4 gap-y-2 mb-5 text-neutral-500" data-astro-cid-qtyrxm4s><div class="flex items-center" data-astro-cid-qtyrxm4s><div class=meta-icon data-astro-cid-qtyrxm4s><svg data-icon=material-symbols:calendar-today-outline-rounded height=1em viewBox="0 0 24 24" width=1em class=text-xl data-astro-cid-qtyrxm4s><symbol id=ai:material-symbols:calendar-today-outline-rounded><path d="M5 22q-.825 0-1.412-.587T3 20V6q0-.825.588-1.412T5 4h1V3q0-.425.288-.712T7 2t.713.288T8 3v1h8V3q0-.425.288-.712T17 2t.713.288T18 3v1h1q.825 0 1.413.588T21 6v14q0 .825-.587 1.413T19 22zm0-2h14V10H5zM5 8h14V6H5zm0 0V6z" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:calendar-today-outline-rounded></use></svg></div><span class="text-50 text-lg font-medium" data-astro-cid-qtyrxm4s>2024-09-03</span></div><!-- <div class="flex items-center">
        <div class="meta-icon"
        >
            <Icon name="material-symbols:book-2-outline-rounded" class="text-xl"></Icon>
        </div>
        <div class="flex flex-row flex-nowrap items-center">
            <a href={url(`/posts/category/${category || 'uncategorized'}/`)} aria-label=`View all posts in the ${category} category`
               class="link-lg transition text-50 text-sm font-medium
                            hover:text-[var(--primary)] dark:hover:text-[var(--primary)] whitespace-nowrap">
                {category || i18n(I18nKey.uncategorized)}
            </a>
        </div>
    </div> --><div class="flex items-center" data-astro-cid-qtyrxm4s><div class=meta-icon data-astro-cid-qtyrxm4s><svg data-icon=material-symbols:book-2-outline-rounded height=1em viewBox="0 0 24 24" width=1em class=text-xl data-astro-cid-qtyrxm4s><symbol id=ai:material-symbols:book-2-outline-rounded><path d="M6 15.325q.35-.175.725-.25T7.5 15H8V4h-.5q-.625 0-1.062.438T6 5.5zM10 15h8V4h-8zm-4 .325V4zM7.5 22q-1.45 0-2.475-1.025T4 18.5v-13q0-1.45 1.025-2.475T7.5 2H18q.825 0 1.413.587T20 4v12.525q0 .2-.162.363t-.588.362q-.35.175-.55.5t-.2.75t.2.763t.55.487t.55.413t.2.562v.25q0 .425-.288.725T19 22zm0-2h9.325q-.15-.35-.237-.712T16.5 18.5q0-.4.075-.775t.25-.725H7.5q-.65 0-1.075.438T6 18.5q0 .65.425 1.075T7.5 20" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:book-2-outline-rounded></use></svg></div><div class="flex items-center flex-row flex-nowrap" data-astro-cid-qtyrxm4s><div class="hidden mx-1.5 text-lg" data-astro-cid-qtyrxm4s>+</div><a href=/posts/tag/simd/ class="transition whitespace-nowrap font-medium dark:hover:text-[var(--primary)] hover:text-[var(--primary)] link-lg text-50 text-lg" aria-label="View all posts with the simd tag" data-astro-cid-qtyrxm4s>simd</a></div></div></div></div><div class="relative overflow-hidden onload-animation banner-container mb-8 rounded-none" id=post-cover><div class="transition absolute pointer-events-none bg-opacity-50 dark:bg-black/10 inset-0"></div><img alt="" src=/_astro/interleaved-vectors-on-arm-dark.DutEqo_x_4pICW.svg decoding=async height=1012 loading=lazy width=1610 class="w-full h-full object-cover" style=object-position:center></div><div class="onload-animation mb-6 custom-md dark:prose-invert markdown-content max-w-none prose prose-base" data-pagefind-body><p>When parsing, we can take advantage of data-level parallelism by operating on more than one byte at a time. Modern CPU architectures provide us with <a href=https://en.wikipedia.org/wiki/Single_instruction,_multiple_data>SIMD (single-instruction, multiple-data)</a> instructions which allow us to do some operation on all bytes in a vector simultaneously. On the latest and greatest x86-64 hardware (with <a href=https://en.wikipedia.org/wiki/AVX-512>AVX-512</a>), we have hardware support for 64-byte vectors. This is convenient because we often want to do a <a href=#movemask>movemask</a> operation which reduces the 64-byte vector into a 64-bit bitstring. Each bit in this “mask” corresponds to a byte in the vector, and can tell us some piece of information like “is it a whitespace?”</p><p><img alt="" src=/_astro/bitstring-reduction-dark.e-pdzM3z_Z146EW6.svg decoding=async height=330 loading=lazy width=1610></p><p>Because modern hardware also has nice bitstring-query operations, we can efficiently do, e.g., a <a href=https://en.wikipedia.org/wiki/Find_first_set>count-trailing-zeroes</a> operation in 1 or 2 cycles to answer questions like “how many non-whitespace characters are there at the start of the vector?”</p><h2 id=enter-arm-neon>Enter ARM Neon<a href=#enter-arm-neon class=anchor><span class=anchor-icon data-pagefind-ignore="">§</span></a></h2><p>On CPU’s sporting the ARM Neon instruction set, like the popular Apple M-series chips, we do not have direct hardware support for 64-byte vectors. Instead, we have to use 4 vectors of 16 bytes each to emulate 64-byte width.</p><p>This leaves us with a choice. We could load in 4 vectors in normal order, like so: (in <a href=https://ziglang.org/ >Zig</a>, we can load in 64 bytes and let the compiler load in 4 vectors for us)</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>export</span><span style=color:#ff79c6> fn</span><span style=color:#50fa7b> load64Bytes</span><span style=color:#f8f8f2>(ptr</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>]</span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#f8f8f2> ptr[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>..</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>].</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>;</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>Aarch64 Assembly emit:</p><pre class="astro-code dracula" data-language=asm style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f8f8f2>ldp     q0, q1, [x0]</span><span style=color:#6272a4>; loads two vectors from pointer `x0`</span></span>
<span class=line><span style=color:#f8f8f2>ldp     q2, q3, [x0, #</span><span style=color:#bd93f9>32</span><span style=color:#f8f8f2>]</span><span style=color:#6272a4>; loads two vectors from `x0+32`</span></span>
<span class=line></span></code></pre><p>Or in interleaved order, like so:</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>export</span><span style=color:#ff79c6> fn</span><span style=color:#50fa7b> load64BytesInterleaved</span><span style=color:#f8f8f2>(ptr</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>]</span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#8be9fd> @bitCast</span><span style=color:#f8f8f2>(std.simd.</span><span style=color:#50fa7b>deinterlace</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>, ptr[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>..</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>].</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>));</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>Aarch64 Assembly emit (we have an instruction for that!):</p><pre class="astro-code dracula" data-language=asm style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f8f8f2>ld4     { v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2> }, [x0]</span></span>
<span class=line></span></code></pre><p>However, interleaved order, hence the name, does not load data in normal order. It loads every 4th byte, with the first vector starting at byte 0, the second vector starting at byte 1, and so on:</p><p><img alt="" src=/_astro/interleaved-vector-dark.C-MamOUS_1DgBuc.svg decoding=async height=410 loading=lazy width=1610></p><p>This strategy is nice for when you have an array of 4 byte structs, where each byte is a separate field.</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>const</span><span style=color:#f8f8f2> rgba </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> { r</span><span style=color:#ff79c6>:</span><span style=color:#ff79c6> u8</span><span style=color:#f8f8f2>, g</span><span style=color:#ff79c6>:</span><span style=color:#ff79c6> u8</span><span style=color:#f8f8f2>, b</span><span style=color:#ff79c6>:</span><span style=color:#ff79c6> u8</span><span style=color:#f8f8f2>, a</span><span style=color:#ff79c6>:</span><span style=color:#ff79c6> u8</span><span style=color:#f8f8f2> };</span></span>
<span class=line></span></code></pre><p>E.g. if you have an array of <code>rgba</code>s, <code>ld4</code> will return your <code>r</code>, <code>g</code>, <code>b</code>, and <code>a</code> values in separate vectors.</p><p>However, even when reordering is not what we’re going for, we can still see efficiency gains by using this facility when <a href=#movemask>movemasking</a> or when doing <a href=#elementwise-shifts>vector element shifts</a>.</p><h2 id=movemask>Movemask<a href=#movemask class=anchor><span class=anchor-icon data-pagefind-ignore="">§</span></a></h2><p>If you want to produce a 64-bit bitstring that tells you where the space characters are in a 64-byte chunk, you might try the following:</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>export</span><span style=color:#ff79c6> fn</span><span style=color:#50fa7b> checkWhitespace</span><span style=color:#f8f8f2>(ptr</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>]</span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>u64</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#8be9fd> @bitCast</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#8be9fd>		@as</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>), ptr[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>..</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>].</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>==</span><span style=color:#8be9fd> @as</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>), </span><span style=color:#8be9fd>@splat</span><span style=color:#f8f8f2>(</span><span style=color:#f1fa8c>' '</span><span style=color:#f8f8f2>))</span></span>
<span class=line><span style=color:#f8f8f2>	);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>At the time of writing, LLVM will give you this emit: (<a href=https://zig.godbolt.org/z/nP44MrMWx>Check what it is today</a>)</p><pre class="astro-code dracula" data-language=asm style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>.</span><span style=color:#50fa7b>LCPI0_0:</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   1</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   2</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   4</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   8</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   16</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   32</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   64</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   128</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   1</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   2</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   4</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   8</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   16</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   32</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   64</span></span>
<span class=line><span style=color:#f8f8f2>    .</span><span style=color:#ff79c6>byte</span><span style=color:#bd93f9>   128</span></span>
<span class=line><span style=color:#50fa7b>checkWhitespace:</span></span>
<span class=line><span style=color:#f8f8f2>    ldp     q0, q1, [x0]</span></span>
<span class=line><span style=color:#f8f8f2>    ldp     q2, q3, [x0, #</span><span style=color:#bd93f9>32</span><span style=color:#f8f8f2>]</span></span>
<span class=line><span style=color:#f8f8f2>    movi    v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>32</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    adrp    x8, .LCPI0_0</span></span>
<span class=line><span style=color:#f8f8f2>    ldr     q5, [x8, :</span><span style=color:#50fa7b>lo12:</span><span style=color:#f8f8f2>.LCPI0_0]</span></span>
<span class=line><span style=color:#ff79c6>    and</span><span style=color:#f8f8f2>     v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v5</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    ext     v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>8</span></span>
<span class=line><span style=color:#f8f8f2>    zip1    v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    addv    h3, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>8h</span></span>
<span class=line><span style=color:#f8f8f2>    fmov    w8, s3</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#ff79c6>    and</span><span style=color:#f8f8f2>     v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v5</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    ext     v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>8</span></span>
<span class=line><span style=color:#f8f8f2>    zip1    v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    addv    h2, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>8h</span></span>
<span class=line><span style=color:#f8f8f2>    fmov    w9, s2</span></span>
<span class=line><span style=color:#f8f8f2>    bfi     w9, w8, #</span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>16</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#ff79c6>    and</span><span style=color:#f8f8f2>     v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v5</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    ext     v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>8</span></span>
<span class=line><span style=color:#f8f8f2>    zip1    v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    addv    h1, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>8h</span></span>
<span class=line><span style=color:#f8f8f2>    fmov    w8, s1</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#ff79c6>    and</span><span style=color:#f8f8f2>     v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v5</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    ext     v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>8</span></span>
<span class=line><span style=color:#f8f8f2>    zip1    v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    addv    h0, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>8h</span></span>
<span class=line><span style=color:#f8f8f2>    fmov    w10, s0</span></span>
<span class=line><span style=color:#f8f8f2>    bfi     w10, w8, #</span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>16</span></span>
<span class=line><span style=color:#f8f8f2>    orr     x0, x10, x9, </span><span style=color:#ff79c6>lsl</span><span style=color:#f8f8f2> #</span><span style=color:#bd93f9>32</span></span>
<span class=line><span style=color:#ff79c6>    ret</span></span>
<span class=line></span></code></pre><p>Unfortunately, LLVM, has not yet seen the light— of interleaved vectors. Here is the x86-64 emit for Zen 4, for reference:</p><pre class="astro-code dracula" data-language=asm style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>.</span><span style=color:#50fa7b>LCPI0_0:</span></span>
<span class=line><span style=color:#f8f8f2>    .zero   </span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>,</span><span style=color:#bd93f9>32</span></span>
<span class=line><span style=color:#50fa7b>checkWhitespace:</span></span>
<span class=line><span style=color:#ff79c6>    vmovdqu64</span><span style=color:#bd93f9>       zmm0</span><span style=color:#f8f8f2>, zmmword ptr [</span><span style=color:#bd93f9>rdi</span><span style=color:#f8f8f2>]</span></span>
<span class=line><span style=color:#ff79c6>    vpcmpeqb</span><span style=color:#f8f8f2>        k0, </span><span style=color:#bd93f9>zmm0</span><span style=color:#f8f8f2>, zmmword ptr [</span><span style=color:#bd93f9>rip</span><span style=color:#f8f8f2> + .LCPI0_0]</span></span>
<span class=line><span style=color:#ff79c6>    kmovq</span><span style=color:#bd93f9>   rax</span><span style=color:#f8f8f2>, k0</span></span>
<span class=line><span style=color:#ff79c6>    vzeroupper</span></span>
<span class=line><span style=color:#ff79c6>    ret</span></span>
<span class=line></span></code></pre><p>This paints Arm/Aarch64 in an unnecessarily bad light. With interleaved vectors, and telling the compiler exactly what we want to do, we can do a lot better.</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>export</span><span style=color:#ff79c6> fn</span><span style=color:#50fa7b> checkWhitespace</span><span style=color:#f8f8f2>(ptr</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>]</span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>u64</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> vec</span><span style=color:#ff79c6>:</span><span style=color:#8be9fd> @Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>=</span><span style=color:#8be9fd> @bitCast</span><span style=color:#f8f8f2>(std.simd.</span><span style=color:#50fa7b>deinterlace</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>, ptr[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>..</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>].</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>));</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> spaces </span><span style=color:#ff79c6>=</span><span style=color:#8be9fd> @select</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>, vec </span><span style=color:#ff79c6>==</span><span style=color:#8be9fd> @as</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>), </span><span style=color:#8be9fd>@splat</span><span style=color:#f8f8f2>(</span><span style=color:#f1fa8c>' '</span><span style=color:#f8f8f2>)),</span></span>
<span class=line><span style=color:#8be9fd>        @as</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>), </span><span style=color:#8be9fd>@splat</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>0xFF</span><span style=color:#f8f8f2>)),</span></span>
<span class=line><span style=color:#8be9fd>        @as</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>), </span><span style=color:#8be9fd>@splat</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>)));</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#50fa7b> vmovmaskq_u8</span><span style=color:#f8f8f2>(spaces);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>fn</span><span style=color:#50fa7b> vmovmaskq_u8</span><span style=color:#f8f8f2>(vec</span><span style=color:#ff79c6>:</span><span style=color:#8be9fd> @Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>)) </span><span style=color:#ff79c6>u64</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> chunks</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>=</span><span style=color:#8be9fd> @bitCast</span><span style=color:#f8f8f2>(vec);</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> t0 </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> vsriq_n_u8</span><span style=color:#f8f8f2>(chunks[</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>], chunks[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>], </span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> t1 </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> vsriq_n_u8</span><span style=color:#f8f8f2>(chunks[</span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>], chunks[</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>], </span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> t2 </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> vsriq_n_u8</span><span style=color:#f8f8f2>(t1, t0, </span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> t3 </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> vsriq_n_u8</span><span style=color:#f8f8f2>(t2, t2, </span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> t4 </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> vshrn_n_u16</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@bitCast</span><span style=color:#f8f8f2>(t3), </span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#8be9fd> @bitCast</span><span style=color:#f8f8f2>(t4);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>This gives us the following assembly (<a href=https://zig.godbolt.org/z/76zEMee5K>See full Zig code and assembly here</a>):</p><pre class="astro-code dracula" data-language=asm style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>checkWhitespace:</span></span>
<span class=line><span style=color:#f8f8f2>    movi    v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>32</span></span>
<span class=line><span style=color:#f8f8f2>    ld4     { v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2> }, [x0]</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v5</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v3</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v4</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v7</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v1</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    cmeq    v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v2</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span></span>
<span class=line><span style=color:#f8f8f2>    sri     v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v7</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>1</span></span>
<span class=line><span style=color:#f8f8f2>    sri     v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v5</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>1</span></span>
<span class=line><span style=color:#f8f8f2>    sri     v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>2</span></span>
<span class=line><span style=color:#f8f8f2>    sri     v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>16b</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>4</span></span>
<span class=line><span style=color:#f8f8f2>    shrn    v0</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>8b</span><span style=color:#f8f8f2>, v6</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>8h</span><span style=color:#f8f8f2>, #</span><span style=color:#bd93f9>4</span></span>
<span class=line><span style=color:#f8f8f2>    fmov    x0, d0</span></span>
<span class=line><span style=color:#ff79c6>    ret</span></span>
<span class=line></span></code></pre><p>This is a lot cleaner! I show and explain how this routine works <a href="https://www.youtube.com/live/FDiUKafPs0U?t=2245">here</a>.</p><h6 id=note-if-you-check-llvm-mca-you-will-find-that-this-is-expected-to-run-slower-than-the-previous-version-if-you-only-care-to-do-a-single-movemask-however-if-you-want-to-do-several-movemasks-simultaneously-this-version-will-be-faster-llvms-cost-model-is-also-conservative-the-shrn-instruction-has-3-cycles-of-latency-on-apple-m3s-performance-core-but-4-cycles-of-latency-on-their-efficiency-core-llvm-treats-it-as-a-4-cycle-operation>Note: if you check LLVM-mca, you will find that this is expected to run slower than the previous version <a href=https://zig.godbolt.org/z/K9nYn1e46>if you only care to do a single movemask</a>. However, if you want to do several movemasks simultaneously, <a href=https://zig.godbolt.org/z/69qYnzjo9>this version will be faster</a>. LLVM’s cost model is also conservative; the <code>shrn</code> instruction has 3 cycles of latency on Apple M3’s performance core, but 4 cycles of latency on their efficiency core. LLVM treats it as a 4-cycle operation.<a href=#note-if-you-check-llvm-mca-you-will-find-that-this-is-expected-to-run-slower-than-the-previous-version-if-you-only-care-to-do-a-single-movemask-however-if-you-want-to-do-several-movemasks-simultaneously-this-version-will-be-faster-llvms-cost-model-is-also-conservative-the-shrn-instruction-has-3-cycles-of-latency-on-apple-m3s-performance-core-but-4-cycles-of-latency-on-their-efficiency-core-llvm-treats-it-as-a-4-cycle-operation class=anchor><span class=anchor-icon data-pagefind-ignore="">§</span></a></h6><h2 id=elementwise-shifts>Elementwise Shifts<a href=#elementwise-shifts class=anchor><span class=anchor-icon data-pagefind-ignore="">§</span></a></h2><p>Initially, I believed we could only do algorithms on interleaved vectors where order didn’t change. However, while working on the UTF8 validator for my <a href=https://github.com/Validark/Accelerated-Zig-Parser>Accelerated-Zig-Parser</a>, I realized we can emulate element shifts in interleaved space.</p><p>Let’s say we have a vector where each byte contains its own index, then shift the elements right by one, shifting in <code>-1</code>. On normal vectors, this looks like so (only showing first 16 bytes of the vector due to space constraints):</p><p><img alt="" src=/_astro/shift-interleaved-dark.Dq_tQlNQ_Z1AXuod.svg decoding=async height=330 loading=lazy width=1610></p><p>This is useful for UTF8 validation because we want to match up the first, second, third, and fourth bytes of a UTF8 codepoint. Hence if we do two more such shifts, shifting in <code>-2</code>, and <code>-3</code>, we can line up our vectors like so:</p><p><img alt="" src=/_astro/shift-interleaved-2-dark.BuSolcp3_Zx8LVH.svg decoding=async height=410 loading=lazy width=1610></p><p>From top to bottom, I will refer to the vectors as <code>prev0</code>, <code>prev1</code>, <code>prev2</code>, and <code>prev3</code>. With the way these four vectors are aligned, we can match the 4th byte of a 4-byte sequence in <code>prev0</code>, the 3rd byte in <code>prev1</code>, the 2nd byte in <code>prev2</code>, and the 1st byte in <code>prev3</code>.</p><p>Now, looking again at the interleaved vectors given by <code>ld4</code>, think about how we might find the relative <code>prev1</code>, <code>prev2</code>, and <code>prev3</code> of each of the following vectors:</p><p><img alt="" src=/_astro/interleaved-vector-dark.C-MamOUS_1DgBuc.svg decoding=async height=410 loading=lazy width=1610></p><p>Here is the <code>prev1</code> for each of the <code>prev0</code> vectors above:</p><p><img alt="" src=/_astro/interleaved-vector-2-dark.BnALExnZ_1LvmR2.svg decoding=async height=410 loading=lazy width=1610></p><p>Hopefully it is obvious that all we did is subtract one from each index. As you can see, the lower 3 vectors we already had! It’s only the uppermost vector which needs to be computed, by shifting in <code>-1</code> to the vector that starts with <code>3</code>, <code>7</code>, <code>11</code>, <code>15</code>, etc.</p><p>That means we can get the semantics of a 64-byte shift by 1 by only shifting a single 16-byte vector!</p><p>Let’s see how this extends to the <code>prev2</code> vectors:</p><p><img alt="" src=/_astro/interleaved-vectors-4-dark.-PfsmSGF_ZWCwbd.svg decoding=async height=410 loading=lazy width=1610></p><p>Same deal as before, the bottom three vectors in this diagram we already had when we computed <code>prev1</code>. Again, we just need to compute the uppermost vector in this diagram by shifting <code>-2</code> into the vector that starts with <code>2</code>, <code>6</code>, <code>10</code>, <code>14</code>, etc.</p><p>We can do the same thing to produce the <code>prev3</code> vectors. The only additional computation needed is that we need to shift in <code>-3</code> to the vector that starts with <code>1</code>, <code>5</code>, <code>9</code>, <code>13</code>, etc. Once we do that, we will have the following vectors:</p><p><img alt="" src=/_astro/interleaved-vectors-5-dark.Bc__sfyb_ZtQWVe.svg decoding=async height=710 loading=lazy width=1610></p><p>In the above diagram, the <code>prev1</code> relative to each of the bottom 4 vectors is the one above it, the <code>prev2</code> relative to each of the bottom 4 vectors is the one 2 above it, and the <code>prev3</code> relative to each of the bottom 4 vectors is the one 3 above it. With only 3 vector shifts, and a total of 7 vectors in play, we can operate on all the shifted vectors we need for a 64-byte chunk. Compare this to needing to produce a separate <code>prev1</code>, <code>prev2</code>, and <code>prev3</code> for each 16-byte vector, which takes a total of 12 vector shifts for 64 bytes. That’s up to 16 vectors in play simulaneously.</p><p>Using this intuition, we can write a function which emulates the semantics of a vector shift by any compile-time known amount on normally-ordered vectors, but for interleaved vectors! This removes the restriction of only using this vector interleaving trick in circumstances where order didn’t change.</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>fn</span><span style=color:#50fa7b> shiftInterleavedElementsRight</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>    vecs</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#ff79c6>    comptime</span><span style=color:#f8f8f2> amount</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#8be9fd;font-style:italic>VectorCount</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>)),</span></span>
<span class=line><span style=color:#f8f8f2>    shift_in</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> std.meta.</span><span style=color:#8be9fd;font-style:italic>Child</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>))</span></span>
<span class=line><span style=color:#f8f8f2>) [</span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>    var</span><span style=color:#f8f8f2> new_vecs </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> vecs;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> ((amount </span><span style=color:#ff79c6>&#x26;</span><span style=color:#bd93f9> 1</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> 1</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>        const</span><span style=color:#f8f8f2> n </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>], </span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>, shift_in);</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> new_vecs[</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>];</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> new_vecs[</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>];</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> new_vecs[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>];</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> n;</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> ((amount </span><span style=color:#ff79c6>&#x26;</span><span style=color:#bd93f9> 2</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> 2</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>        const</span><span style=color:#f8f8f2> n1 </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>], </span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>, shift_in);</span></span>
<span class=line><span style=color:#ff79c6>        const</span><span style=color:#f8f8f2> n0 </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>], </span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>, shift_in);</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> new_vecs[</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>];</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> new_vecs[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>];</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> n1;</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> n0;</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    const</span><span style=color:#f8f8f2> leftover_amt </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> amount </span><span style=color:#ff79c6>>></span><span style=color:#bd93f9> 2</span><span style=color:#f8f8f2>;</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> (leftover_amt </span><span style=color:#ff79c6>></span><span style=color:#bd93f9> 0</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>        new_vecs </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> .{</span></span>
<span class=line><span style=color:#f8f8f2>            std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>], leftover_amt, shift_in),</span></span>
<span class=line><span style=color:#f8f8f2>            std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>], leftover_amt, shift_in),</span></span>
<span class=line><span style=color:#f8f8f2>            std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>], leftover_amt, shift_in),</span></span>
<span class=line><span style=color:#f8f8f2>            std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(new_vecs[</span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>], leftover_amt, shift_in)</span></span>
<span class=line><span style=color:#f8f8f2>        };</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#f8f8f2> new_vecs;</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h2 id=prefix-sums>Prefix sums<a href=#prefix-sums class=anchor><span class=anchor-icon data-pagefind-ignore="">§</span></a></h2><p>While interleaved vectors are a clear win for reducing the number of vector shifts required for our UTF8 use-case, even emulating a 64-byte vector shift by doing only a single 16-byte shift (!!), it doesn’t always work out favorably.</p><p>The prefix-sum algorithm includes a situation with worse performance for interleaved vectors relative to normal-ordered vectors:</p><pre class="astro-code dracula" data-language=zig style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>fn</span><span style=color:#50fa7b> prefixSum</span><span style=color:#f8f8f2>(vec_</span><span style=color:#ff79c6>:</span><span style=color:#8be9fd> @Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>)) </span><span style=color:#8be9fd>@Vector</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>64</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>u8</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>    var</span><span style=color:#f8f8f2> vec </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> vec_ </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(vec_, </span><span style=color:#bd93f9>1</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>    vec </span><span style=color:#ff79c6>+=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(vec, </span><span style=color:#bd93f9>2</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>    vec </span><span style=color:#ff79c6>+=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(vec, </span><span style=color:#bd93f9>4</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>    vec </span><span style=color:#ff79c6>+=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(vec, </span><span style=color:#bd93f9>8</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>    vec </span><span style=color:#ff79c6>+=</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(vec, </span><span style=color:#bd93f9>16</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#f8f8f2> vec </span><span style=color:#ff79c6>+</span><span style=color:#f8f8f2> std.simd.</span><span style=color:#50fa7b>shiftElementsRight</span><span style=color:#f8f8f2>(vec, </span><span style=color:#bd93f9>32</span><span style=color:#f8f8f2>, </span><span style=color:#bd93f9>0</span><span style=color:#f8f8f2>);</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>To compute the last two lines, where we want to shift by 16 and 32 respectively, each of those will require 4 vector shifts and 4 adds to simulate over interleaved vectors. <a href=https://zig.godbolt.org/z/xWEoKq5cz>However, with normally-ordered vectors, 0 instructions are necessary to shift by multiples of 16 (the vector length), and only 3 and 2 adds are needed respectively</a> (because adding a vector of all zeroes is optimized away). See <a href=https://zig.godbolt.org/z/nq99edxf9>here</a> for a playground showing the prefix-sum performed in interleaved space versus normal space.</p><p>If we consider that each line of the <code>prefixSum</code> function “should” take 4 vector shift (<code>ext</code>) and 4 add instructions, the interleaved variant saves 5 vector shift instructions on the first two lines, and the normal version saves 8 vector shift instructions and 3 adds on the last two lines. That means the normal version takes 6 fewer instructions per iteration.</p><p>However, using interleaved vectors has instruction-level-parallelism advantages that almost even it out. <a href=https://zig.godbolt.org/z/f45WE4eTe>According to LLVM-mca</a>, the Apple M3 can do a prefix sum in interleaved space in ~14.86 cycles, whereas it can do it in normal (non-interleaved) space in ~12.87 cycles, a difference of ~1.99 cycles, despite the difference of 6 instructions.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=anchor><span class=anchor-icon data-pagefind-ignore="">§</span></a></h2><p>So next time you want to parse <a href=https://github.com/simdutf/simdutf/issues/428>utf8</a>, or <a href=https://github.com/simdjson/simdjson>JSON</a>, or <a href=https://github.com/Validark/Accelerated-Zig-Parser>Zig</a>, be sure to use interleaved vectors!</p></div><div class="transition overflow-hidden bg-[var(--license-block-bg)] license-container mb-6 onload-animation px-6 py-5 relative rounded-xl"><div class="transition font-bold dark:text-white/75 text-black/75">Use interleaved vectors for parsing on ARM</div><a href=https://validark.github.io/posts/interleaved-vectors-on-arm/ class="text-[var(--primary)] link">https://validark.github.io/posts/interleaved-vectors-on-arm/</a><div class="flex gap-6 mt-2"><div><div class="transition dark:text-white/30 text-black/30 text-sm">Author</div><div class="transition whitespace-nowrap dark:text-white/75 text-black/75">Niles Salter</div></div><div><div class="transition dark:text-white/30 text-black/30 text-sm">Published at</div><div class="transition whitespace-nowrap dark:text-white/75 text-black/75">2024-09-03</div></div><div><div class="transition dark:text-white/30 text-black/30 text-sm">License</div><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="text-[var(--primary)] link whitespace-nowrap" target=_blank>CC BY-NC-SA 4.0</a></div></div><svg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em class="transition absolute pointer-events-none -translate-y-1/2 dark:text-white/5 right-6 text-[15rem] text-black/5 top-1/2"><symbol id=ai:fa6-brands:creative-commons><path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82" fill=currentColor /></symbol><use xlink:href=#ai:fa6-brands:creative-commons></use></svg></div></div></div><div class="flex w-full flex-col gap-4 mb-4 justify-between md:flex-row overflow-hidden"><a href=# class="w-full active:scale-95 font-bold overflow-hidden pointer-events-none"></a> <a href=# class="w-full active:scale-95 font-bold overflow-hidden pointer-events-none"></a></div></main></div><div class="onload-animation col-span-2 grid-rows-3 mt-4" id=footer><div class="flex items-center card-base max-w-[var(--page-width)] mx-auto min-h-[4.5rem] px-6 rounded-b-none"><div class="transition text-sm text-50">© 2024 Niles Salter. All Rights Reserved. <a href=/rss.xml class="text-[var(--primary)] link font-medium" target=_blank>RSS</a> ∗ <a href=/sitemap-index.xml class="text-[var(--primary)] link font-medium" target=_blank>Sitemap</a> ∗ <a href=https://astro.build class="text-[var(--primary)] link font-medium" target=_blank>Astro</a> ∗ <a href=https://github.com/saicaca/fuwari class="text-[var(--primary)] link font-medium" target=_blank>Fuwari</a></div></div></div><div class="hidden lg:block back-to-top-wrapper" data-astro-cid-eymb5ayk><div class="transition flex items-center back-to-top-btn hide overflow-hidden rounded-2xl" id=back-to-top-btn data-astro-cid-eymb5ayk onclick=backToTop()><button class="btn-card h-[3.75rem] w-[3.75rem]" aria-label="Back to Top" data-astro-cid-eymb5ayk><svg data-icon=material-symbols:keyboard-arrow-up-rounded height=1em viewBox="0 0 24 24" width=1em class=mx-auto data-astro-cid-eymb5ayk><symbol id=ai:material-symbols:keyboard-arrow-up-rounded><path d="m12 10.8l-3.9 3.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.6-4.6q.3-.3.7-.3t.7.3l4.6 4.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275z" fill=currentColor /></symbol><use xlink:href=#ai:material-symbols:keyboard-arrow-up-rounded></use></svg></button></div></div><script>function backToTop(){window.scroll({top:0,behavior:"smooth"})}function scrollFunction(){let o=document.getElementById("back-to-top-btn");document.body.scrollTop>600||document.documentElement.scrollTop>600?o.classList.remove("hide"):o.classList.add("hide")}window.onscroll=scrollFunction</script></div></div></body></html>